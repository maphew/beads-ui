<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue {{.Issue.ID}} - Beady</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“¿</text></svg>">
    <link rel="stylesheet" href="/static/pico.pumpkin.css">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
    <header>
        <div class="header-top">
            <nav aria-label="breadcrumb">
                <ol>
                    <li><a href="/">Home</a></li>
                    <li>{{.Issue.ID}}</li>
                </ol>
            </nav>
            <div class="theme-control">
                <label for="theme-select">Theme:</label>
                <select id="theme-select" aria-label="Select theme">
                    <option value="auto">Auto</option>
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                </select>
            </div>
        </div>
    </header>

    <main>
        <article class="card">
            <header>
                <h1>{{.Issue.ID}}: {{.Issue.Title}}</h1>
            </header>

            <!-- Quick Actions -->
            <div class="issue-actions grid">
                <div>
                    <label for="status-select">Status:</label>
                    <select id="status-select"
                            hx-post="/api/issue/status/{{.Issue.ID}}"
                            hx-trigger="change"
                            hx-vals='js:{"status": event.target.value, "username": localStorage.getItem("beady-username") || ""}'
                            hx-swap="none">
                        <option value="open" {{if eq (.Issue.Status | lower) "open"}}selected{{end}}>Open</option>
                        <option value="in_progress" {{if eq (.Issue.Status | lower) "in_progress"}}selected{{end}}>In Progress</option>
                        <option value="closed" {{if eq (.Issue.Status | lower) "closed"}}selected{{end}}>Closed</option>
                    </select>
                </div>

                <div>
                    <label for="priority-select">Priority:</label>
                    <select id="priority-select"
                            hx-post="/api/issue/priority/{{.Issue.ID}}"
                            hx-trigger="change"
                            hx-vals='js:{"priority": parseInt(event.target.value), "username": localStorage.getItem("beady-username") || ""}'
                            hx-swap="none">
                        <option value="0" {{if eq .Issue.Priority 0}}selected{{end}}>P0</option>
                        <option value="1" {{if eq .Issue.Priority 1}}selected{{end}}>P1</option>
                        <option value="2" {{if eq .Issue.Priority 2}}selected{{end}}>P2</option>
                        <option value="3" {{if eq .Issue.Priority 3}}selected{{end}}>P3</option>
                        <option value="4" {{if eq .Issue.Priority 4}}selected{{end}}>P4</option>
                    </select>
                </div>

                {{if ne (.Issue.Status | lower) "closed"}}
                <div>
                    <label>&nbsp;</label>
                    <button onclick="showCloseDialog()" class="secondary">Close Issue</button>
                </div>
                {{end}}
            </div>

            <p><strong>Type:</strong> {{.Issue.IssueType}}</p>
            <p><strong>Created:</strong> {{.Issue.CreatedAt}}</p>
            <p><strong>Updated:</strong> {{.Issue.UpdatedAt}}</p>
            {{if .Issue.Description}}
            <div><strong>Description:</strong></div>
            <p style="white-space: pre-wrap;">{{.Issue.Description}}</p>
            {{end}}
            {{if .Issue.Design}}
            <div><strong>Design:</strong></div>
            <p style="white-space: pre-wrap;">{{.Issue.Design}}</p>
            {{end}}
            {{if .Issue.AcceptanceCriteria}}
            <div><strong>Acceptance Criteria:</strong></div>
            <p style="white-space: pre-wrap;">{{.Issue.AcceptanceCriteria}}</p>
            {{end}}
            <details>
                <summary><strong>Notes</strong></summary>
                <div id="notes-section">
                    {{if .Issue.Notes}}
                    <p style="white-space: pre-wrap;">{{.Issue.Notes}}</p>
                    {{else}}
                    <p><em>No notes yet.</em></p>
                    {{end}}
                </div>
                <form hx-post="/api/issue/notes/{{.Issue.ID}}"
                      hx-vals='js:{"notes": document.querySelector("#notes-text").value, "username": localStorage.getItem("beady-username") || ""}'
                      hx-on::after-request="if(event.detail.successful) { window.location.reload(); }">
                    <textarea id="notes-text" name="notes" placeholder="Add or update notes..." rows="4">{{.Issue.Notes}}</textarea>
                    <button type="submit">Save Notes</button>
                </form>
            </details>
        </article>

        {{if .HasDeps}}
        <section class="tabs">
            <nav>
                <ul>
                    <li><a href="#deps" aria-current="page">Dependencies</a></li>
                    <li><a href="#blocked">Blocked By</a></li>
                </ul>
            </nav>
            <div id="deps">
                <ul>
                    {{range .Deps}}
                    <li><a href="/issue/{{.ID}}">{{.ID}}: {{.Title}}</a></li>
                    {{end}}
                </ul>
                {{if not .Deps}}<p>No dependencies.</p>{{end}}
            </div>
            <div id="blocked">
                <ul>
                    {{range .Dependents}}
                    <li><a href="/issue/{{.ID}}">{{.ID}}: {{.Title}}</a></li>
                    {{end}}
                </ul>
                {{if not .Dependents}}<p>Not blocking any issues.</p>{{end}}
            </div>
        </section>
        {{end}}

        <section>
            <h3>Labels</h3>
            <div id="labels-container" class="labels-container">
                {{range .Labels}}
                <span class="label">
                    {{.}}
                    <button class="label-remove"
                            hx-delete="/api/issue/labels/{{$.Issue.ID}}/{{.}}"
                            hx-target="#labels-container"
                            hx-swap="outerHTML"
                            aria-label="Remove label">Ã—</button>
                </span>
                {{end}}
                {{if not .Labels}}<p>No labels.</p>{{end}}
            </div>
            <form hx-post="/api/issue/labels/{{.Issue.ID}}"
                  hx-target="#labels-container"
                  hx-swap="outerHTML"
                  class="label-form">
                <input type="text" name="label" placeholder="Add label..." required>
                <button type="submit">Add Label</button>
            </form>
        </section>

        <section>
            <h3>Comments</h3>
            <div id="comments-list">
                {{if .Issue.Comments}}
                <ul>
                    {{range .Issue.Comments}}
                    <li>
                        <strong>{{.CreatedAt}}</strong>{{if .CreatedBy}} by {{.CreatedBy}}{{end}}
                        <p style="white-space: pre-wrap;">{{.Text}}</p>
                    </li>
                    {{end}}
                </ul>
                {{else}}
                <p>No comments.</p>
                {{end}}
            </div>
            <form hx-post="/api/issue/comments/{{.Issue.ID}}"
                  hx-vals='js:{"text": document.querySelector("#comment-text").value, "username": localStorage.getItem("beady-username") || ""}'
                  hx-on::after-request="if(event.detail.successful) { document.querySelector('#comment-text').value = ''; window.location.reload(); }"
                  class="comment-form">
                <textarea id="comment-text" name="text" placeholder="Add a comment..." rows="3" required></textarea>
                <button type="submit">Add Comment</button>
            </form>
        </section>

        <section>
            <h3>Recent Events</h3>
            <ul>
                {{range .Events}}
                <li>{{.CreatedAt}}: {{.EventType}}</li>
                {{end}}
            </ul>
            {{if not .Events}}<p>No recent events.</p>{{end}}
        </section>

        <div class="actions">
            <a href="/graph/{{.Issue.ID}}" class="btn">View Dependency Graph</a>
        </div>
    </main>

    <!-- Close Issue Dialog -->
    <dialog id="close-dialog">
        <article>
            <header>
                <button aria-label="Close" rel="prev" onclick="document.getElementById('close-dialog').close()"></button>
                <h3>Close Issue</h3>
            </header>
            <form hx-post="/api/issue/close/{{.Issue.ID}}"
                  hx-vals='js:{"reason": document.querySelector("#close-reason").value, "username": localStorage.getItem("beady-username") || ""}'
                  hx-on::after-request="if(event.detail.successful) { window.location.reload(); }">
                <label for="close-reason">Reason for closing (optional):</label>
                <input type="text" id="close-reason" name="reason" placeholder="e.g., completed, duplicate, won't fix">
                <footer>
                    <button type="button" class="secondary" onclick="document.getElementById('close-dialog').close()">Cancel</button>
                    <button type="submit">Close Issue</button>
                </footer>
            </form>
        </article>
    </dialog>

    <script src="/static/app.js"></script>
    <script>
        function showCloseDialog() {
            document.getElementById('close-dialog').showModal();
        }

        // Prompt for username on first visit
        document.addEventListener('DOMContentLoaded', function() {
            if (!localStorage.getItem('beady-username')) {
                const username = prompt('Enter your username for attribution:');
                if (username) {
                    localStorage.setItem('beady-username', username);
                }
            }
        });

        // HTMX event handlers
        document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.successful) {
                // Show success message
                console.log('Request successful');
            } else {
                // Show error message
                alert('Error: ' + (event.detail.xhr.responseText || 'Request failed'));
            }
        });
    </script>
</body>
</html>
